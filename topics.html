<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Gilat AI - ××™× ×“×§×¡ × ×•×©××™×</title>

   <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

   <style>
       :root {
           --primary-color: #00897b; /* ×¦×‘×¢ ×˜×•×¨×§×™×– ×œ× ×•×©××™× */
           --bg-color: #f4f7f6;
           --card-bg: #ffffff;
           --text-color: #333;
           --border-color: #e0e0e0;
           --hover-bg: #e0f2f1;
           --meta-color: #555;

           --active-bg: #f0fdf4;
           --active-border: #86efac;
       }

       body {
           font-family: 'Heebo', sans-serif;
           background-color: var(--bg-color);
           color: var(--text-color);
           margin: 0;
           padding: 20px;
           direction: rtl; text-align: right;
       }

       .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }

       header { display: flex; flex-direction: column; margin-bottom: 20px; }
       .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
       h1 { color: var(--primary-color); margin: 0; }

       .version-tag { display: block; font-size: 0.45em; color: #888; font-weight: normal; margin-top: 4px; letter-spacing: 0.5px; }

       /* --- Control Panel (Sort & Stats) --- */
       .controls-row {
           margin-top: 20px; background: white; padding: 15px 20px; border-radius: 10px;
           box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between;
           font-size: 0.9em; color: #555;
       }

       .stats-group { display: flex; gap: 15px; align-items: center; }
       .sort-group { display: flex; gap: 10px; align-items: center; }

       .stat-number { font-weight: bold; color: var(--primary-color); font-size: 1.1em; }

       /* Sort Buttons */
       .sort-btn {
           background: #f5f5f5; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px;
           cursor: pointer; font-size: 0.9em; transition: all 0.2s; color: #555;
       }
       .sort-btn:hover { background: #e0e0e0; }
       .sort-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

       /* Tooltips */
       .has-tooltip { position: relative; cursor: help; }
       .tooltip-content {
           visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: right;
           border-radius: 6px; padding: 10px; position: absolute; z-index: 100;
           bottom: 125%; right: 50%; transform: translateX(50%); opacity: 0; transition: opacity 0.3s;
           font-size: 0.85rem; line-height: 1.4; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
       }
       .tooltip-content::after {
           content: ""; position: absolute; top: 100%; right: 50%; margin-right: -5px;
           border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent;
       }
       .has-tooltip:hover .tooltip-content { visibility: visible; opacity: 1; }

       /* --- Filter Status Bar --- */
       #filter-status {
           background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
           padding: 10px; border-radius: 6px; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between;
       }

       /* --- Grid --- */
       .topics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }

       .topic-card {
           background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;
           padding: 15px; text-decoration: none; color: var(--text-color); transition: all 0.2s;
           display: flex; flex-direction: column; min-height: 110px; position: relative; overflow: visible;
       }
       .topic-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary-color); }

       .topic-card.active-topic { background-color: #e0f2f1; border-color: #80cbc4; } /* ×™×¨×•×§ ×˜×•×¨×§×™×– ×‘×”×™×¨ */

       .topic-name { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; line-height: 1.3; }

       .stats-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: auto; }

       .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; border: 1px solid #eee; background: #fafafa; }
       .badge-count { background: #e0f7fa; color: #006064; border-color: #b2ebf2; font-weight: bold; }
       .badge-avg-high { background: #d1fae5; color: #047857; border-color: #6ee7b7; font-weight: bold; }

       /* Top Table */
       .top-section { margin-top: 50px; background: white; padding: 25px; border-radius: 12px; border-top: 4px solid var(--primary-color); }
       .top-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
       .top-table th { text-align: right; padding: 12px; background-color: #f8f9fa; border-bottom: 2px solid #eee; }
       .top-table td { padding: 12px; border-bottom: 1px solid #eee; }
       .top-table a { text-decoration: none; color: #333; font-weight: bold; }

       /* Common */
       .nav-links { display: flex; gap: 10px; }
       .nav-btn { text-decoration: none; background-color: var(--primary-color); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 0.9em; cursor: pointer; border: none; }
       .nav-btn.secondary { background-color: #546e7a; }

       .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
       @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

       /* Detail View */
       .doc-item { background: white; border-right: 4px solid var(--primary-color); padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
       .doc-title { font-size: 1.25em; font-weight: bold; text-decoration: none; color: var(--primary-color); display: block; margin-bottom: 8px; }
       .doc-meta { font-size: 0.9em; color: var(--meta-color); display: flex; align-items: center; gap: 10px; border-top: 1px dashed #eee; padding-top: 10px; margin-top: 10px;}
       .pdf-btn { display: inline-flex; align-items: center; background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; padding: 4px 10px; border-radius: 4px; text-decoration: none; font-weight: bold; font-size: 0.85em; margin-right: auto; }

       .empty-msg { text-align: center; color: #666; margin-top: 30px; }
   </style>
</head>
<body>

   <div class="container">
       <header>
           <div class="header-top">
               <h1>
                   ğŸ·ï¸ ××™× ×“×§×¡ ××™×œ×•×ª ××¤×ª×—
                   <span class="version-tag">v1.0 â€¢ Topics & Trends</span>
               </h1>
               <div class="nav-links">
                   <a href="index.html" class="nav-btn secondary">×—×™×¤×•×©</a>
                   <a href="stats.html" class="nav-btn secondary">×¡×˜×˜×™×¡×˜×™×§×•×ª</a>
                   <a href="authors.html" class="nav-btn secondary">××—×‘×¨×™×</a>
                   <a href="topics.html" class="nav-btn" id="all-topics-btn" style="display:none;">â† ×—×–×¨×” ×œ×¨×©×™××”</a>
               </div>
           </div>

           <div id="controls-panel" class="controls-row" style="display:none;">
               <div class="stats-group">
                   <span>×¡×”"×› × ×•×©××™×: <span id="total-count" class="stat-number">0</span></span>
                   <span style="border-right:1px solid #ccc; height:15px;"></span>
                   <span>× ×•×©××™× ×¤×¢×™×œ×™×: <span id="active-count" class="stat-number">0</span></span>
               </div>

               <div class="sort-group">
                   <span>××™×™×Ÿ ×œ×¤×™:</span>
                   <button class="sort-btn active" onclick="sortTopics('count')">ğŸ”¥ × ×¤×•×¥ ×‘×™×•×ª×¨</button>
                   <button class="sort-btn" onclick="sortTopics('avg')">ğŸ“ˆ ×××•×¦×¢ ×’×‘×•×”</button>
                   <button class="sort-btn" onclick="sortTopics('years')">â³ ×•×•×ª×§ (×©× ×™×)</button>
                   <button class="sort-btn" onclick="sortTopics('az')">ğŸ”¤ ×-×‘</button>
               </div>
           </div>
       </header>

       <div id="loader" class="loader" style="display:none;"></div>

       <div id="topics-list-view" style="display:none;">
           <div class="topics-grid" id="topics-container"></div>

           <div class="top-section" id="top-topics-container">
               <h2>ğŸ”¥ × ×•×©××™× ××•×‘×™×œ×™× ×‘×××•×¦×¢ ×©× ×ª×™</h2>
               <table class="top-table">
                   <thead>
                       <tr>
                           <th>#</th>
                           <th>×©× ×”× ×•×©×</th>
                           <th>×××•×¦×¢ ×œ×©× ×”</th>
                           <th>×¡×š ××¡××›×™×</th>
                           <th>×˜×•×•×— ×©× ×™×</th>
                           <th>×¡×˜×˜×•×¡</th>
                       </tr>
                   </thead>
                   <tbody id="top-table-body"></tbody>
               </table>
           </div>
       </div>

       <div id="topic-detail-view" style="display:none;">
           <div class="author-header"> <h2 id="detail-topic-name"></h2>
               <p>×¨×©×™××ª ××¡××›×™× ×‘×”× ××•×¤×™×¢ ×”×‘×™×˜×•×™ (×××•×™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š)</p>
           </div>
           <div id="documents-container"></div>
       </div>

   </div>

   <script>
       const apiKey = "zqt_WQdPgppS5OLumkFHZXSffKRBLzOS1MmAq-c0HA";
       const corpusKey = "mmm_docs5";
       const headers = { "x-api-key": apiKey, "Accept": "application/json", "Content-Type": "application/json" };

       let allTopicsData = [];
       let currentSort = 'count';

       window.onload = function() {
           const urlParams = new URLSearchParams(window.location.search);
           const topicParam = urlParams.get('topic');

           if (topicParam) {
               document.getElementById('all-topics-btn').style.display = 'inline-block';
               document.getElementById('controls-panel').style.display = 'none';
               loadTopicDocuments(topicParam);
           } else {
               initTopicsList();
           }
       };

       async function initTopicsList() {
           const container = document.getElementById('topics-container');
           const view = document.getElementById('topics-list-view');
           const loader = document.getElementById('loader');
           const controls = document.getElementById('controls-panel');

           view.style.display = 'none';
           loader.style.display = 'block';

           try {
               const response = await fetch(`topics_data.json?t=${new Date().getTime()}`);
               if (response.ok) {
                   const data = await response.json();
                   // ×¡×™× ×•×Ÿ ×¨××©×•× ×™: ×¨×§ × ×•×©××™× ×¢× ×™×•×ª×¨ ×-2 ××¡××›×™× (×œ×× ×•×¢ ×¨×¢×©)
                   allTopicsData = data.topics.filter(t => t.count >= 2);

                   const activeTopics = allTopicsData.filter(t => t.is_active).length;
                   document.getElementById('total-count').innerText = allTopicsData.length;
                   document.getElementById('active-count').innerText = activeTopics;

                   controls.style.display = 'flex';

                   // ××™×•×Ÿ ×•×¨×™× ×“×•×¨ ×¨××©×•× ×™
                   sortTopics('count'); // ×‘×¨×™×¨×ª ××—×“×œ
                   renderTopTable(allTopicsData);

                   loader.style.display = 'none';
                   view.style.display = 'block';
               } else {
                   throw new Error("Missing topics_data.json");
               }
           } catch (e) {
               console.warn(e);
               loader.style.display = 'none';
               container.innerHTML = "<p class='empty-msg'>×§×•×‘×¥ × ×ª×•× ×™× ×—×¡×¨. × × ×œ×”×¨×™×¥ ××ª ×¡×§×¨×™×¤×˜ ×”×¢×“×›×•×Ÿ.</p>";
               view.style.display = 'block';
           }
       }

       // --- ×œ×•×’×™×§×ª ××™×•×Ÿ ---
       function sortTopics(criteria) {
           currentSort = criteria;

           // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™×
           document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
           document.querySelector(`.sort-btn[onclick="sortTopics('${criteria}')"]`).classList.add('active');

           let sorted = [...allTopicsData];

           switch(criteria) {
               case 'count':
                   sorted.sort((a, b) => b.count - a.count);
                   break;
               case 'avg':
                   sorted.sort((a, b) => b.avg_per_year - a.avg_per_year);
                   break;
               case 'years':
                   sorted.sort((a, b) => b.span_years - a.span_years);
                   break;
               case 'az':
                   sorted.sort((a, b) => a.value.localeCompare(b.value, 'he'));
                   break;
           }

           renderGrid(document.getElementById('topics-container'), sorted);
       }

       // --- ×¨×™× ×“×•×¨ ×”×’×¨×™×“ ---
       function renderGrid(container, topicsArray) {
           const html = topicsArray.map(topic => {
               const activeClass = topic.is_active ? 'active-topic' : '';
               const activeTooltip = topic.is_active
                   ? "<b>× ×•×©× ×¤×¢×™×œ:</b><br>×”×•×¤×™×¢ ×‘××¡××›×™× ×‘×©× ×” ×”××—×¨×•× ×”."
                   : "<b>× ×•×©× ×œ× ×¤×¢×™×œ:</b><br>×œ× ×”×•×¤×™×¢ ×‘×©× ×” ×”××—×¨×•× ×”.";

               const yearsHtml = topic.years_range
                   ? `<span class="badge has-tooltip">${topic.years_range}
                        <span class="tooltip-content"><b>×©× ×•×ª ×¤×¢×™×œ×•×ª:</b><br>×”×©× ×” ×”×¨××©×•× ×” ×•×”××—×¨×•× ×” ×‘×” ×”×•×¤×™×¢ ×”× ×•×©× (×¡×”"×› ${topic.span_years} ×©× ×™×).</span>
                      </span>`
                   : '';

               let avgClass = '';
               if (topic.avg_per_year >= 3.0) avgClass = 'badge-avg-high';

               const avgHtml = `<span class="badge ${avgClass} has-tooltip">Ã˜ ${topic.avg_per_year}
                                  <span class="tooltip-content"><b>×××•×¦×¢ ×œ×©× ×”:</b><br>××¡×¤×¨ ×”××¡××›×™× ×—×œ×§×™ ×˜×•×•×— ×”×©× ×™×.</span>
                                </span>`;

               return `
               <div style="position:relative;">
                   <a href="topics.html?topic=${encodeURIComponent(topic.value)}" class="topic-card ${activeClass} has-tooltip">
                       <div class="topic-name">${topic.value}</div>
                       <span class="tooltip-content" style="bottom:100%; right:0; transform:none;">${activeTooltip}</span>

                       <div class="stats-badges">
                           <span class="badge badge-count">${topic.count} ××¡××›×™×</span>
                           ${yearsHtml}
                           ${avgHtml}
                       </div>
                   </a>
               </div>
               `;
           }).join('');

           container.innerHTML = html;
       }

       function renderTopTable(topics) {
           const tbody = document.getElementById('top-table-body');
           const sorted = [...topics].sort((a, b) => b.avg_per_year - a.avg_per_year);
           const top10 = sorted.slice(0, 10);

           const html = top10.map((topic, index) => {
               const activeBadge = topic.is_active
                   ? '<span style="color:green; font-weight:bold;">â— ×¤×¢×™×œ</span>'
                   : '<span style="color:#ccc;">×œ× ×¤×¢×™×œ</span>';

               return `
                   <tr>
                       <td>${index + 1}</td>
                       <td><a href="topics.html?topic=${encodeURIComponent(topic.value)}">${topic.value}</a></td>
                       <td style="font-weight:bold; color:var(--primary-color)">${topic.avg_per_year}</td>
                       <td>${topic.count}</td>
                       <td>${topic.years_range}</td>
                       <td>${activeBadge}</td>
                   </tr>
               `;
           }).join('');

           tbody.innerHTML = html;
       }

       // --- ×˜×¢×™× ×ª ××¡××›×™× ×œ× ×•×©× ×‘×•×“×“ ---
       async function loadTopicDocuments(topicName) {
           const loader = document.getElementById('loader');
           const view = document.getElementById('topic-detail-view');
           const container = document.getElementById('documents-container');
           const titleEl = document.getElementById('detail-topic-name');

           document.getElementById('topics-list-view').style.display = 'none';
           loader.style.display = 'block';
           titleEl.innerText = `× ×•×©×: ${topicName}`;

           try {
               const safeName = topicName.replace(/'/g, "\\'");
               // ×©×™××•×© ×‘×¤×™×œ×˜×¨ IN ×œ×¨×©×™××ª ××™×œ×•×ª ××¤×ª×—
               const filterString = `'${safeName}' IN doc.ez_keywords`;

               const requestData = {
                   query: "",
                   search: {
                       corpora: [{ corpus_key: corpusKey, metadata_filter: filterString }],
                       offset: 0, limit: 100
                   }
               };

               const response = await fetch("https://api.vectara.io/v2/query", {
                   method: "POST", headers: headers, body: JSON.stringify(requestData)
               });
               const data = await response.json();
               const results = data.search_results || [];

               // ×œ×•×’×™×§×ª ×ª×¦×•×’×ª ××¡××›×™× ×–×”×” ×œ××—×‘×¨×™×
               const uniqueDocs = new Map();
               results.forEach(res => {
                   const docId = res.document_id;
                   if (!uniqueDocs.has(docId)) {
                       const meta = res.document_metadata || {};
                       uniqueDocs.set(docId, {
                           id: docId,
                           title: meta.title || "×œ×œ× ×›×•×ª×¨×ª",
                           date: meta.ez_date || meta.date || "×œ× ×¦×•×™×Ÿ",
                           url: meta.url || "#",
                           author: meta.ez_people ? meta.ez_people.join(', ') : (meta.author || "×œ× ×™×“×•×¢"),
                           snippet: res.text || ""
                       });
                   }
               });

               let docsArray = Array.from(uniqueDocs.values());
               docsArray.sort((a, b) => {
                   if (a.date === "×œ× ×¦×•×™×Ÿ") return 1;
                   if (b.date === "×œ× ×¦×•×™×Ÿ") return -1;
                   return b.date.localeCompare(a.date);
               });

               if (docsArray.length === 0) {
                   container.innerHTML = "<p class='empty-msg'>×œ× × ××¦××• ××¡××›×™×.</p>";
               } else {
                   const pdfIcon = `<svg class="pdf-icon" viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>`;
                   const docsHtml = docsArray.map(doc => {
                       const fullUrl = doc.url !== "#" ? `${doc.url}#page=1` : "#";
                       return `
                           <div class="doc-item">
                               <a href="${fullUrl}" target="_blank" class="doc-title">${doc.title}</a>
                               <div class="doc-meta">
                                   <span><strong>×ª××¨×™×š:</strong> ${doc.date}</span>
                                   <span style="margin:0 5px">|</span>
                                   <span><strong>××—×‘×¨:</strong> ${doc.author}</span>
                                   ${doc.url !== "#" ? `<a href="${fullUrl}" target="_blank" class="pdf-btn" style="margin-right:auto">${pdfIcon} ×¤×ª×— ××¡××š</a>` : ''}
                               </div>
                           </div>
                       `;
                   }).join('');
                   container.innerHTML = docsHtml;
               }

               loader.style.display = 'none';
               view.style.display = 'block';

           } catch (e) {
               console.error(e);
               loader.style.display = 'none';
           }
       }
   </script>
</body>
</html>