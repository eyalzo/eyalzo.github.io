<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
   <meta http-equiv="Pragma" content="no-cache">
   <meta http-equiv="Expires" content="0">

   <title>×—×™×¤×•×© ×‘××"×</title>
   <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

   <style>
       :root {
           /* ×©×•××¨×™× ×¢×œ ×”×›×—×•×œ ×¢×‘×•×¨ ×“×£ ×”×—×™×¤×•×© ×›×“×™ ×œ×”×‘×“×™×œ ××•×ª×• ××“×£ ×”× ×•×©××™× */
           --primary-color: #0056b3;
           --bg-color: #f4f7f6;
           --container-bg: #ffffff;
           --text-color: #333;
           --border-color: #e0e0e0;

           --tag-bg: #e3f2fd;
           --tag-text: #0d47a1;
           --tag-hover: #bbdefb;

           --demo-color: #f3e5f5;
           --demo-text: #7b1fa2;
       }

       body {
           font-family: 'Heebo', sans-serif;
           background-color: var(--bg-color);
           color: var(--text-color);
           margin: 0;
           padding: 20px;
       }

       .container { max-width: 900px; margin: 0 auto; padding-bottom: 50px; }

       /* --- Header Styling (Match Topics) --- */
       header { display: flex; flex-direction: column; margin-bottom: 30px; }

       .header-top {
           display: flex;
           justify-content: space-between;
           align-items: flex-start;
           width: 100%;
       }

       .title-area { display: flex; flex-direction: column; }

       h1 { color: var(--primary-color); margin: 0; font-size: 2em; line-height: 1.2; }

       .version-info {
           font-size: 0.8rem;
           color: #999;
           font-weight: normal;
           margin-top: 4px;
       }

       /* Navigation */
       .nav-links { display: flex; gap: 10px; }
       .nav-btn {
           text-decoration: none; background-color: var(--primary-color); color: white;
           padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 0.9em;
           cursor: pointer; border: none; transition: background 0.2s;
       }
       .nav-btn:hover { background-color: #004494; }
       .nav-btn.secondary { background-color: #546e7a; }
       .nav-btn.secondary:hover { background-color: #37474f; }

       /* --- Search Box --- */
       .search-section {
           background: var(--container-bg); padding: 25px; border-radius: 12px;
           box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;
       }

       .search-wrapper { position: relative; display: flex; align-items: center; }

       input[type="text"] {
           width: 100%; padding: 14px; padding-left: 40px;
           border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px;
           text-align: right; transition: border 0.3s; font-family: inherit;
       }
       input[type="text"]:focus { outline: none; border-color: var(--primary-color); }

       .clear-btn {
           position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
           cursor: pointer; color: #999; font-size: 18px; display: none; padding: 5px;
       }
       .clear-btn:hover { color: #333; }

       button[type="submit"] {
           width: 100%; padding: 12px; background-color: var(--primary-color);
           color: white; border: none; border-radius: 8px; font-size: 18px;
           cursor: pointer; margin-top: 15px; transition: background 0.3s; font-weight: bold;
       }
       button[type="submit"]:hover { background-color: #004494; }
       button[type="submit"]:disabled { background-color: #ccc; cursor: not-allowed; }

       /* --- Tags --- */
       .tags-area { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
       .tags-label { font-size: 0.9em; font-weight: bold; color: #555; min-width: 60px; }
       .tag-pill {
           padding: 6px 12px; border-radius: 20px; font-size: 0.9em; cursor: pointer;
           border: 1px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 8px; white-space: nowrap;
       }
       .history-pill { background-color: var(--tag-bg); color: var(--tag-text); }
       .history-pill:hover { background-color: var(--tag-hover); }
       .demo-pill { background-color: var(--demo-color); color: var(--demo-text); }
       .demo-pill:hover { background-color: #e1bee7; }
       .tag-code { background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 10px; font-size: 0.8em; font-weight: bold; opacity: 0.8; }

       /* --- Results --- */
       .summary-box {
           background-color: #f0f8ff; border: 1px solid #cce5ff; padding: 20px;
           border-radius: 8px; line-height: 1.8; font-size: 1.05em; color: #000;
           white-space: pre-wrap; text-align: right; direction: rtl; margin-bottom: 30px;
       }
       .citation-link {
           color: var(--primary-color); font-weight: bold; text-decoration: none;
           background-color: #e6f2ff; padding: 0 4px; border-radius: 4px; margin: 0 2px; cursor: pointer;
       }

       .search-result {
           background: #fff; border: 1px solid #e1e4e8; border-right: 4px solid var(--primary-color);
           padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
           text-align: right; direction: rtl; transition: transform 0.2s;
       }
       .highlight-result { animation: flash-bg 2s ease-out; }
       @keyframes flash-bg { 0% { background-color: #fff9c4; } 100% { background-color: #fff; } }

       .result-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px; }

       .document-title {
           font-weight: bold; color: var(--primary-color); text-decoration: none; font-size: 1.2em;
           display: inline-block; direction: rtl; text-align: right;
       }
       .document-title:hover { text-decoration: underline; }

       .result-number {
           background: #eee; padding: 4px 10px; border-radius: 6px;
           font-weight:bold; font-size:0.9em; color: #555; flex-shrink: 0;
       }

       .score-badge {
           background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 12px;
           font-size: 0.8em; font-weight: bold; margin-right: auto;
       }

       .snippet-text {
           margin-top: 10px; line-height: 1.6; font-size: 1em; color: #333;
           text-align: right; direction: rtl; unicode-bidi: embed;
       }

       /* Keywords */
       .keywords-container { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }
       .keyword-tag {
           background: #f5f5f5; color: #666; border: 1px solid #ddd;
           padding: 2px 8px; border-radius: 4px; font-size: 0.8em;
           text-decoration: none; transition: all 0.2s;
       }
       .keyword-tag:hover { background-color: #e0e0e0; color: #333; border-color: #ccc; }

       .metadata-footer {
           font-size: 0.9em; color: #666; margin-top: 15px; border-top: 1px dashed #eee;
           padding-top: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
       }

       .pdf-btn {
           display: inline-flex; align-items: center; background-color: #ffebee; color: #d32f2f;
           border: 1px solid #ffcdd2; padding: 6px 14px; border-radius: 6px; text-decoration: none;
           font-weight: bold; font-size: 0.9em; transition: all 0.2s;
       }
       .pdf-btn:hover { background-color: #d32f2f; color: white; border-color: #b71c1c; }
       .pdf-btn svg { width: 18px; height: 18px; margin-left: 8px; fill: currentColor; }

       .loader {
           border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color);
           border-radius: 50%; width: 50px; height: 50px;
           animation: spin 1s linear infinite; margin: 30px auto; display: none;
       }
       @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
   </style>
</head>
<body>

   <div class="container">
       <header>
           <div class="header-top">
               <div class="title-area">
                   <h1>ğŸ” ×× ×•×¢ ×—×™×¤×•×© ××"×</h1>
                   <div class="version-info">v2.0 â€¢ 15/12/2025</div>
               </div>

               <div class="nav-links">
                   <a href="topics.html" class="nav-btn secondary">ğŸ·ï¸ ××™× ×“×§×¡ × ×•×©××™×</a>
               </div>
           </div>
       </header>

       <div class="search-section">
           <form onsubmit="handleFormSubmit(); return false;">
               <div class="search-wrapper">
                   <input type="text" id="query" placeholder="×”×§×œ×“ × ×•×©× ×œ×—×™×¤×•×©..." oninput="toggleClearButton()" required>
                   <span id="clearBtn" class="clear-btn" onclick="clearInput()" title="× ×§×” ×˜×§×¡×˜">âœ–</span>
               </div>

               <div id="history-area" class="tags-area"></div>
               <div id="suggestions-area" class="tags-area"></div>

               <button type="submit" id="submitBtn">×—×¤×©</button>
           </form>
       </div>

       <div id="loader" class="loader"></div>

       <div id="results-area" style="display:none;">
           <h3>âœ¨ ×¡×™×›×•× ×ª×©×•×‘×”:</h3>
           <div id="summary-text" class="summary-box"></div>

           <h3>ğŸ“š ××¡××›×™× ×¨×œ×•×•× ×˜×™×™×:</h3>
           <div id="search-results"></div>
       </div>
   </div>

   <script>
       const HISTORY_KEY = 'gilat_ai_history';
       const DEMO_QUERIES = [
           "×”×× ×™×© ×œ× ×• ××¡××›×™× ×”××–×›×™×¨×™× ××ª ×©×¢×¨ ×”×“×•×œ×¨, ×©× ×›×ª×‘×• ×‘××”×œ×š 2023 ×•××—×¨×™×”",
           "×—××™×©×” × ×•×©××™× ×¢×œ×™×”× ×›×ª×‘× ×• ×‘×©× ×ª 2018"
       ];

       window.onload = function() {
           const inputEl = document.getElementById("query");
           inputEl.focus();
           loadHistory();
           renderSuggestions();
           toggleClearButton();
           const urlParams = new URLSearchParams(window.location.search);
           const queryParam = urlParams.get('query');
           if (queryParam) {
               inputEl.value = queryParam;
               toggleClearButton();
               sendQuery(queryParam, false);
           }
       };

       function handleFormSubmit() {
           const query = document.getElementById("query").value;
           if(query) {
               const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?query=' + encodeURIComponent(query);
               window.history.pushState({path:newUrl},'',newUrl);
               sendQuery(query, true);
           }
       }

       function truncateText(text, limit = 40) {
           if (text.length <= limit) return text;
           return text.substring(0, limit) + '...';
       }

       function toggleClearButton() {
           const input = document.getElementById("query");
           const clearBtn = document.getElementById("clearBtn");
           clearBtn.style.display = input.value.trim().length > 0 ? "block" : "none";
       }

       function clearInput() {
           const input = document.getElementById("query");
           input.value = "";
           toggleClearButton();
           input.focus();
       }

       function generateShortCode(str) {
           let hash = 0;
           for (let i = 0; i < str.length; i++) {
               const char = str.charCodeAt(i);
               hash = ((hash << 5) - hash) + char;
               hash = hash & hash;
           }
           return Math.abs(hash % 10000);
       }

       function saveToHistory(text) {
           let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
           const code = generateShortCode(text);
           history = history.filter(item => item.text !== text);
           history.unshift({ text: text, code: code });
           if (history.length > 20) history.pop();
           localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
           loadHistory();
       }

       function loadHistory() {
           const historyArea = document.getElementById('history-area');
           const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
           historyArea.innerHTML = '';
           const recentItems = history.slice(0, 3);
           if (recentItems.length > 0) {
               historyArea.innerHTML = '<span class="tags-label">××—×¨×•× ×™×:</span>';
               recentItems.forEach(item => {
                   const pill = document.createElement('div');
                   pill.className = 'tag-pill history-pill';
                   pill.onclick = () => {
                       document.getElementById('query').value = item.text;
                       toggleClearButton();
                       handleFormSubmit();
                   };
                   pill.innerHTML = `${truncateText(item.text)} <span class="tag-code">#${item.code}</span>`;
                   pill.title = item.text;
                   historyArea.appendChild(pill);
               });
           }
       }

       function renderSuggestions() {
           const suggestionsArea = document.getElementById('suggestions-area');
           suggestionsArea.innerHTML = '<span class="tags-label">×”×¦×¢×•×ª:</span>';
           DEMO_QUERIES.forEach(query => {
               const pill = document.createElement('div');
               pill.className = 'tag-pill demo-pill';
               pill.onclick = () => {
                   document.getElementById('query').value = query;
                   toggleClearButton();
                   handleFormSubmit();
               };
               pill.innerHTML = truncateText(query);
               pill.title = query;
               suggestionsArea.appendChild(pill);
           });
       }

       async function sendQuery(queryText, shouldSaveHistory) {
           const apiKey = "zqt_WQdPgppS5OLumkFHZXSffKRBLzOS1MmAq-c0HA";
           const corpusKey = "mmm_docs5";

           const loader = document.getElementById("loader");
           const resultsArea = document.getElementById("results-area");
           const submitBtn = document.getElementById("submitBtn");
           const summaryDiv = document.getElementById("summary-text");
           const searchResultsDiv = document.getElementById("search-results");

           if (!queryText.trim()) return;

           if (shouldSaveHistory) {
               saveToHistory(queryText);
           }

           loader.style.display = "block";
           resultsArea.style.display = "none";
           submitBtn.disabled = true;
           submitBtn.innerText = "××¢×‘×“ × ×ª×•× ×™×...";
           summaryDiv.innerHTML = "";
           searchResultsDiv.innerHTML = "";

           const url = "https://api.vectara.io/v2/query";
           const requestData = {
               query: queryText,
               search: {
                   corpora: [{ corpus_key: corpusKey, metadata_filter: "", lexical_interpolation: 0.005, custom_dimensions: {} }],
                   offset: 0,
                   limit: 10,
                   context_configuration: { sentences_before: 2, sentences_after: 2, start_tag: "<b>", end_tag: "</b>" },
                   reranker: { type: "customer_reranker", reranker_id: "rnk_272725719" }
               },
               stream_response: false,
               generation: {
                   generation_preset_name: "vectara-summary-table-md-query-ext-jan-2025-gpt-4o",
                   max_used_search_results: 10,
                   prompt_template: "[\n  {\"role\": \"system\", \"content\": \"You are a search bot that forms a coherent answer to a user query based on search results that are provided to you.\" },\n  {\"role\": \"user\", \"content\": \" [INSTRUCTIONS]\n    Search results may include tables in a markdown format. When answering a question using a table be careful about which rows and columns contain the answer and include all relevant information from the relevant rows and columns that the query is asking about.\n    Do not cobble facts together from multiple search results, instead summarize the main facts into a consistent and easy to understand response.\n    Do not base your response on information or knowledge that is not in the search results.\n    Make sure your response is answering the query asked. If the query is related to an entity (such as a person or place), make sure you use search results related to that entity.\n    For queries where only a short answer is required, you can give a brief response.\n    Consider that each search result is a partial segment from a bigger text, and may be incomplete.\n    Your output should always be in a single language - the $vectaraLangName language. Check spelling and grammar for the $vectaraLangName language.\n    Search results for the query *** $vectaraQuery***, are listed below, some are text, some MAY be tables in the format described above.\n    #foreach ($qResult in $vectaraQueryResultsDeduped)\n      [$esc.java($foreach.index + 1)]\n      #if($qResult.hasTable())\n        Table Title: $qResult.getTable().title() || Table Description: $qResult.getTable().description() || Table Data:\n        $qResult.getTable().markdown()\n      #else\n        $qResult.getText()\n      #end\n    #end\n    Generate a coherent response (but no more than $vectaraOutChars characters) to the query *** $vectaraQuery *** by summarizing the search results provided. Give a slight preference to search results that appear earlier in the list.\n    Only cite relevant search results in your answer following these specific instructions: $vectaraCitationInstructions\n    Respond always in the Hebrew language, and only in that language.\"}\n]",
                   response_language: "heb",
                   model_parameters: { llm_name: "gpt-4o" },
                   enable_factual_consistency_score: true
               },
               save_history: true
           };

           try {
               const response = await fetch(url, {
                   method: "POST",
                   headers: {
                       "Content-Type": "application/json",
                       "Accept": "application/json",
                       "x-api-key": apiKey,
                       "customer-id": "1493651330"
                   },
                   body: JSON.stringify(requestData)
               });

               if (!response.ok) {
                   const errorData = await response.json();
                   throw new Error(JSON.stringify(errorData));
               }

               const data = await response.json();

               if (data.summary) {
                   const processedSummary = data.summary.replace(/\[(\d+)\]/g, (match, number) => {
                       return `<a href="#result-${number}" class="citation-link" onclick="highlightResult(${number})">[${number}]</a>`;
                   });
                   summaryDiv.innerHTML = processedSummary;
               } else {
                   summaryDiv.innerText = "×œ× ×”×ª×§×‘×œ ×¡×™×›×•×.";
               }

               if (data.search_results && data.search_results.length > 0) {
                   data.search_results.forEach((result, index) => {
                       const resultDiv = document.createElement("div");
                       resultDiv.className = "search-result";
                       const resultNum = index + 1;
                       resultDiv.id = `result-${resultNum}`;

                       const rawUrl = result.document_metadata.url || '#';
                       const docUrl = rawUrl.includes('#') ? rawUrl : `${rawUrl}#page=${result.part_metadata.page}`;

                       // --- ×œ×•×’×™×§×” ××©×•×¤×¨×ª ---

                       // 1. ××—×‘×¨×™× (×œ×œ× ×§×™×©×•×¨)
                       let writersParts = [];
                       if (result.document_metadata.author) {
                           writersParts.push(result.document_metadata.author);
                       }
                       if (result.document_metadata.additional_authors) {
                           writersParts.push(result.document_metadata.additional_authors);
                       }
                       let authorsHtml = writersParts.length > 0 ? writersParts.join(', ') : '×œ× ×¦×•×™×Ÿ';

                       // 2. ×¨"×¦
                       if (result.document_metadata.teamleader) {
                           if (writersParts.length > 0) {
                               authorsHtml += '<span class="meta-separator">|</span>';
                           } else if (authorsHtml === '×œ× ×¦×•×™×Ÿ') {
                               authorsHtml = '';
                           }
                           authorsHtml += `<strong>×¨"×¦:</strong> ${result.document_metadata.teamleader}`;
                       }

                       // 3. × ×™×§×•×“
                       const scorePercent = (result.score * 100).toFixed(1) + '%';

                       // 4. ××™×œ×•×ª ××¤×ª×— (×¢× ×§×™×©×•×¨×™× ×œ-topics.html)
                       let keywordsHtml = '';
                       let rawKeywords = result.document_metadata.keywords || result.document_metadata.Keywords || result.document_metadata.ez_keywords;

                       if (rawKeywords) {
                           // ×˜×™×¤×•×œ ×‘××¢×¨×›×™× ××• ××—×¨×•×–×•×ª
                           let keywordList = [];
                           if (Array.isArray(rawKeywords)) {
                               keywordList = rawKeywords;
                           } else {
                               keywordList = rawKeywords.split(/;|,\s*/);
                           }

                           if (keywordList.length > 0) {
                               keywordsHtml = '<div class="keywords-container">';
                               keywordList.forEach(k => {
                                   const cleanKey = k.trim();
                                   if(cleanKey) {
                                       // ×”×§×™×©×•×¨ ××¢×‘×™×¨ ×œ×“×£ ×”× ×•×©××™×
                                       keywordsHtml += `<a href="topics.html?topic=${encodeURIComponent(cleanKey)}" class="keyword-tag">${cleanKey}</a>`;
                                   }
                               });
                               keywordsHtml += '</div>';
                           }
                       }

                       const pdfIcon = `<svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>`;

                       resultDiv.innerHTML = `
                           <div class="result-header">
                               <span class="result-number">#${resultNum}</span>
                               <a href="${docUrl}" target="_blank" class="document-title">ğŸ“„ ${result.document_metadata.title || '××¡××š ×œ×œ× ×›×•×ª×¨×ª'}</a>
                               <span class="score-badge" title="×¨××ª ×”×ª×××”">${scorePercent}</span>
                           </div>

                           <div class="snippet-text">${result.text}</div>

                           ${keywordsHtml}

                           <div class="metadata-footer">
                               <div style="flex-grow: 1;">
                                   <strong>×ª××¨×™×š:</strong> ${result.document_metadata.date || '-'} |
                                   <strong>××—×‘×¨×™×:</strong> ${authorsHtml}
                               </div>
                               <a href="${docUrl}" target="_blank" class="pdf-btn" title="×¤×ª×— ××ª ×”××¡××š ×”××œ×">
                                   ${pdfIcon} ×¤×ª×— ××¡××š
                               </a>
                           </div>
                       `;
                       searchResultsDiv.appendChild(resultDiv);
                   });
               } else {
                   searchResultsDiv.innerHTML = "<p>×œ× × ××¦××• ××¡××›×™× ×¨×œ×•×•× ×˜×™×™×.</p>";
               }

               resultsArea.style.display = "block";

           } catch (error) {
               console.error("Error:", error);
               alert("×©×’×™××”:\n" + error.message);
           } finally {
               loader.style.display = "none";
               submitBtn.disabled = false;
               submitBtn.innerText = "×—×¤×©";
           }
       }

       function highlightResult(num) {
           const element = document.getElementById(`result-${num}`);
           if (element) {
               element.classList.remove('highlight-result');
               void element.offsetWidth;
               element.classList.add('highlight-result');
               element.scrollIntoView({ behavior: 'smooth', block: 'center' });
           }
       }
   </script>
</body>
</html>