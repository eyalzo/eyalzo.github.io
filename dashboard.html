import pandas as pd
import json
from IPython.display import HTML, display

# 1. הגדרת ה-ID של הקובץ והפיכתו לקישור CSV
file_id = '14XeOz-9kXnV4amzKGTFwKNblHv4jY2SY'
url = f'https://docs.google.com/spreadsheets/d/{file_id}/export?format=csv'

try:
    # 2. קריאת הנתונים
    df = pd.read_csv(url)
    
    # --- שלב הטיוב והסינון ---
    
    # א. סינון גורמים זרים
    exclude_list = ['ecprd', 'oecd', 'ipu', 'פרלמנט זר']
    mask_exclude = df['גורם מבקש [לקוח]'].str.contains('|'.join(exclude_list), case=False, na=False)
    df = df[~mask_exclude].copy()
    
    # ב. טיפול בתאריכים וחילוץ שנה
    df['תאריך הבקשה'] = pd.to_datetime(df['תאריך הבקשה'], errors='coerce')
    df = df.dropna(subset=['תאריך הבקשה'])
    df['year'] = df['תאריך הבקשה'].dt.year.astype(int)
    
    # ג. לוגיקת סטטוס
    df['status_final'] = df['סטטוס הבקשה'].fillna('אחר')
    df.loc[df['תאריך מסירה בפועל'].notna(), 'status_final'] = 'בוצע'
    
    def merge_status(s):
        if s == 'בוצע': return 'בוצע'
        if s in ['נסגר ביוזמת היחידה', 'בוטל ביוזמת גורם מבקש']: return 'נסגר או בוטל'
        if s in ['בביצוע', 'לפני ביצוע', 'ממתין לאישור ראש צוות']: return 'בביצוע'
        return s
    df['status_final'] = df['status_final'].apply(merge_status)
    
    # ד. טיפול בסיווג לקוח (סדר עדיפות מחייב לפי הנחיות מעודכנות)
    col_client = 'סיווג לקוח ‏(גורם מבקש [לקוח]) ‏(תיק לקוח)'
    col_requester = 'גורם מבקש [לקוח]'
    col_initiated = 'מסמך יזום'

    def classify_client_logic(row):
        client = str(row[col_client])
        req = str(row[col_requester])
        init = str(row[col_initiated])
        
        # 1. עדיפות ראשונה: שימור ועדה וח"כ מהסיווג המקורי
        if "ועדה" in client: return "ועדה"
        if "ח" in client and "כ" in client: return "ח\"כ"
        
        # 2. עדיפות שנייה: גורם מבקש = כל חברי הכנסת
        if req == "כל חברי הכנסת": return "ח\"כ"
        
        # 3. עדיפות שלישית: כלל יזומים (דורס סיווגים אחרים שאינם ועדה/ח"כ)
        if init == "כן" and req == "מרכז המחקר והמידע": return "יזומים"
            
        # 4. עדיפות רביעית: מיזוג יחידה פנימית (כולל ייעוץ משפטי)
        if client in ["יועץ משפטי", "ייעוץ משפטי", "יחידה פנימית"]: return "יחידה פנימית"
        
        # 5. ברירת מחדל
        return "אחר"

    df['client_type_final'] = df.apply(classify_client_logic, axis=1)
    
    # ה. אגרגציות לדשבורד
    summary = df.groupby(['year', 'status_final', 'client_type_final']).size().reset_index(name='count')
    json_data = summary.to_dict(orient='records')
    
    min_year, max_year = int(summary['year'].min()), int(summary['year'].max())
    total_requests = int(summary['count'].sum())

    # --- יצירת ה-HTML ---
    html_template = f"""
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body {{ font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; }}
        .container {{ background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1250px; margin: auto; }}
        .header {{ display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 15px; }}
        .filters {{ background: #f8fafc; padding: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; }}
        .kpi-row {{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }}
        .kpi-card {{ background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; text-align: center; }}
        .kpi-val {{ font-size: 24px; font-weight: bold; color: #1a73e8; }}
        .charts-grid {{ display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }}
        .full-chart {{ grid-column: span 2; border: 1px solid #eee; border-radius: 10px; padding: 10px; }}
        input[type="range"] {{ width: 200px; cursor: pointer; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 style="margin:0">דשבורד בקשות מידע - כנסת ישראל ({total_requests:,} בקשות)</h2>
            <button style="background:#1a73e8; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer" onclick="downloadHTML()">הורד דשבורד</button>
        </div>

        <div class="filters">
            <span>מ- <span id="minL" style="color:#1a73e8; font-weight:bold">{min_year}</span></span>
            <input type="range" id="minS" min="{min_year}" max="{max_year}" value="{min_year}">
            <input type="range" id="maxS" min="{min_year}" max="{max_year}" value="{max_year}">
            <span>עד <span id="maxL" style="color:#1a73e8; font-weight:bold">{max_year}</span></span>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">סה"כ משימות<div id="kTotal" class="kpi-val"></div></div>
            <div class="kpi-card">בוצעו<div id="kDone" class="kpi-val" style="color:#28a745"></div></div>
            <div class="kpi-card">בביצוע<div id="kPending" class="kpi-val" style="color:#fd7e14"></div></div>
            <div class="kpi-card">נסגר/בוטל<div id="kClosed" class="kpi-val" style="color:#dc3545"></div></div>
        </div>

        <div class="charts-grid">
            <div id="barChart" class="full-chart" style="height: 400px;"></div>
            <div id="pieStatus" style="height: 450px; border:1px solid #eee; border-radius:10px"></div>
            <div id="pieClient" style="height: 450px; border:1px solid #eee; border-radius:10px"></div>
        </div>
    </div>

    <script>
        const data = {json.dumps(json_data, ensure_ascii=False)};
        const minS = document.getElementById('minS'), maxS = document.getElementById('maxS');
        const minL = document.getElementById('minL'), maxL = document.getElementById('maxL');

        function update() {{
            let v1 = parseInt(minS.value), v2 = parseInt(maxS.value);
            if (v1 > v2) {{ if (this === minS) maxS.value = v1; else minS.value = v2; v1 = parseInt(minS.value); v2 = parseInt(maxS.value); }}
            minL.innerText = v1; maxL.innerText = v2;

            const filtered = data.filter(d => d.year >= v1 && d.year <= v2);
            let t=0, d_count=0, p=0, c=0;
            const yearsMap = {{}}, statusMap = {{}}, clientMap = {{}};

            filtered.forEach(item => {{
                t += item.count;
                if (item.status_final === 'בוצע') d_count += item.count;
                else if (item.status_final === 'בביצוע') p += item.count;
                else if (item.status_final === 'נסגר או בוטל') c += item.count;
                
                yearsMap[item.year] = (yearsMap[item.year] || 0) + item.count;
                statusMap[item.status_final] = (statusMap[item.status_final] || 0) + item.count;
                clientMap[item.client_type_final] = (clientMap[item.client_type_final] || 0) + item.count;
            }});

            document.getElementById('kTotal').innerText = t.toLocaleString();
            document.getElementById('kDone').innerText = d_count.toLocaleString();
            document.getElementById('kPending').innerText = p.toLocaleString();
            document.getElementById('kClosed').innerText = c.toLocaleString();

            // 1. בר שנתי
            const xY = Object.keys(yearsMap).sort();
            Plotly.newPlot('barChart', [{{
                x: xY, y: xY.map(y => yearsMap[y]), type: 'bar', text: xY.map(y => yearsMap[y]),
                textposition: 'inside', marker: {{color: '#1a73e8'}}
            }}], {{ title: 'התפלגות שנתית לכמות המשימות', xaxis: {{tickformat: 'd'}} }});

            // 2. עוגת סטטוס
            const sLabels = Object.keys(statusMap);
            Plotly.newPlot('pieStatus', [{{
                labels: sLabels, values: sLabels.map(l => statusMap[l]), type: 'pie', hole: 0.4,
                marker: {{colors: sLabels.map(l => l==='בוצע'?'#28a745':(l==='נסגר או בוטל'?'#dc3545':null))}},
                textinfo: 'value+percent'
            }}], {{ title: 'התפלגות סטאטוס המשימות', legend: {{orientation:'h', y:-0.1}} }});

            // 3. עוגת לקוחות (Donut, ללא Legend, אחוז מעוגל לספרה אחת)
            const cLabels = Object.keys(clientMap);
            Plotly.newPlot('pieClient', [{{
                labels: cLabels, values: cLabels.map(l => clientMap[l]), 
                type: 'pie', hole: 0.5,
                textinfo: 'label+value+percent', 
                texttemplate: '%{{label}}<br>%{{value}}<br>%{{percent:.1%}}',
                showlegend: false, 
                domain: {{ x: [0.1, 0.9] }}
            }}], {{ 
                title: 'התפלגות משימות לפי סוגי לקוחות',
                margin: {{ t: 50, b: 20, l: 20, r: 20 }}
            }});
        }}

        function downloadHTML() {{
            const blob = new Blob([document.documentElement.outerHTML], {{ type: 'text/html' }});
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = 'knesset_dashboard.html';
            a.click();
        }}
        minS.oninput = update; maxS.oninput = update;
        update();
    </script>
</body>
</html>
    """

    with open('dashboard.html', 'w', encoding='utf-8') as f:
        f.write(html_template)
    
    display(HTML(html_template))

except Exception as e:
    print(f"שגיאה בעיבוד: {{e}}")